var app=app||{};!function(){"use strict";var e=function(e){this.species=ko.observable(e.binomial),this.keywords=e.keywords.toLowerCase(),this.isVisible=ko.observable(!1),this.sightings=e.sightings,this.drawMapMarker=function(){var e;e=this.isVisible()?app.map.map:null;for(var t=0,a=this.sightings.length;a>t;t++)this.sightings[t].marker.setMap(e)},this.taxon=function(){if(e.wm){var t=[],a=e.wm.taxon;for(var n in a)t.push(n+": "+a[n]);return t.join(" | ")}return""}.bind(this)(),this.commonNames=e.wm?"Also known as: "+e.wm.commonNames.join(", ")+".":""},t=function(t){this.speciesNames=[],this.species=ko.observableArray(function(a){a=a||t.species;var n=[];for(var i in a)n.push(new e(a[i])),this.speciesNames.push(a[i].binomial);return n}.bind(this)()),this.filterStr=ko.observable(""),this.tempFilterStr="",this.filteredSpecies=ko.computed(function(){return this.species().filter(function(e){return e.isVisible(e.keywords.indexOf(this.filterStr().toLowerCase())>=0),e.isVisible()}.bind(this))}.bind(this)),this.photos=ko.observableArray(),this.listClick=function(e){this.toggleFilterStr(e.species())}.bind(this),this.mapMarkerBounce=function(e){for(var t=e.sightings,a=0,n=t.length;n>a;a++)t[a].marker.setAnimation(google.maps.Animation.BOUNCE)},this.mapMarkerPuncture=function(e){for(var t=e.sightings,a=0,n=t.length;n>a;a++)t[a].marker.setAnimation(null)},this.toggleFilterStr=function(e){this.filterStr()===e?this.filterStr(this.tempFilterStr):(this.tempFilterStr=this.filterStr(),this.filterStr(e))}};app.map={options:{center:{lat:-33.844,lng:151.112},zoom:17,mapTypeId:google.maps.MapTypeId.TERRAIN,disableDefaultUI:!0},toggleInfoWindow:function(e,t){var n=a.getContent(),i=app.data.species[e].wm?app.data.species[e].wm.iwHTML:e;n!==i?(a.setContent(i),a.open(this.map,t)):n===i&&app.data.currentSighting.marker===t?($("#add-new").fadeIn(),a.setContent(""),a.close()):(a.close(),a.open(this.map,t))}};var a=new google.maps.InfoWindow({content:""});google.maps.event.addListener(a,"closeclick",function(){$("#add-new").fadeIn(),a.setContent(""),app.viewModel.photos(null),app.data.currentSighting.deselect(!0),app.data.currentSighting=""}),app.newEntryInfoWindow=null,app.newEntryMarker=null,app.lastEntryMarker=null,app.undoLastEntry=function(){$("#messages").fadeOut(),app.lastEntryMarker.setMap(null),app.viewModel.species().pop(),delete app.data.species[app.viewModel.speciesNames.pop()]},app.saveNewSighting=function(){var t=$("#new-name")[0].value;if(t.length<3)return void alert("That doesn't appear to be a valid name.");t=t[0].toUpperCase()+t.slice(1).toLowerCase();var a=app.newEntryMarker.getPosition(),n={name:t,lat:a.A,lng:a.F,date:new Date},i=app.viewModel.speciesNames.indexOf(t),s=function(){if(-1===i){if(app.viewModel.species().push(new e(app.data.species[t])),app.viewModel.speciesNames.push(t),app.lastEntryMarker=app.data.species[t].sightings[0].marker,void 0===app.data.species[t].wm||"unknown"===app.data.species[t].wm.taxon.kingdom)return alert("Homo sapiens"===t?t+" considered harmful.":"Unable to find that species on Wikipedia. \nIf you spelled it correctly, then my Wikiparser has let you down, sorry :("),app.viewModel.species().pop(),void delete app.data.species[app.viewModel.speciesNames.pop()]}else{var a=app.data.species[t].sightings[0].marker.icons,n=app.data.species[t].sightings.pop();n.marker.icons.unselected=a.unselected,n.marker.icons.selected=a.selected,n.marker.setIcon(a.unselected),app.data.species[t].sightings.push(n),app.lastEntryMarker=n.marker}$(".dialog").find("em").text(t),$("#messages").fadeIn(),setTimeout(function(){$("#messages").fadeOut("slow")},5e3),app.viewModel.filterStr("//"),app.viewModel.filterStr("")};-1===i?(app.data.addNewSpecies(n,s),app.data.addNewSighting(n)):app.data.addNewSighting(n,s),app.newEntryInfoWindow.setContent(""),app.newEntryMarker.setMap(null),$("#save-new").fadeOut(),$("#add-new").fadeIn("slow")},app.newSighting=function(){$("#add-new").fadeOut(),$("#save-new").fadeIn("slow"),app.data.currentSighting&&(app.data.currentSighting.deselect(),a.close()),this.map.map.panTo(this.map.options.center),app.newEntryMarker=new google.maps.Marker({position:this.map.options.center,map:app.map.map,draggable:!0,icon:"images/sblank.png",title:"Drag me!"}),app.newEntryInfoWindow=new google.maps.InfoWindow,app.newEntryInfoWindow.setContent($("#new-sighting-info-window").html()),app.newEntryInfoWindow.open(this.map.map,app.newEntryMarker),google.maps.event.addListener(app.newEntryInfoWindow,"closeclick",function(){$("#save-new").fadeOut(),$("#add-new").fadeIn("slow"),app.newEntryInfoWindow.close(),app.newEntryMarker.setMap(null)}),$("#new-name").keyup(function(e){13===e.which&&app.saveNewSighting()})};var n=function(){app.map.map=new google.maps.Map(document.getElementById("map-canvas"),app.map.options)};google.maps.event.addDomListener(window,"load",n),window.onload=function(){app.viewModel=new t(app.data),ko.applyBindings(app.viewModel)}}();