var app=app||{data:{species:{},currentSighting:null}};!function(){"use strict";app.data.basic=[{name:"Erithacus rubecula",lat:-33.844263,lng:151.113756,date:new Date("October 13, 2013")},{name:"Erithacus rubecula",lat:-33.843263,lng:151.111756,date:new Date("September 14, 2014")},{name:"Fuchsia magellanica",lat:-33.844548,lng:151.110811,date:new Date("October 1, 2015")},{name:"Polyommatus icarus",lat:-33.845096,lng:151.113337,date:new Date("September 13, 2014")},{name:"Geranium robertianum",lat:-33.844717,lng:151.110467,date:new Date("September 13, 2013")},{name:"Arenaria interpres",lat:-33.844948,lng:151.111011,date:new Date("January 1, 2012")},{name:"Marchantia polymorpha",lat:-33.845343,lng:151.110789,date:new Date("January 2, 2014")}];var a={unknown:"images/blank.png",plants:"images/plant.png","plants-s":"images/splant.png",fishes:"images/fish.png","fishes-s":"images/sfish.png",animals:"images/blank.png","animals-s":"images/sblank.png",mammals:"images/animal.png","mammals-s":"images/sanimal.png","flowering plants":"images/flower.png","flowering plants-s":"images/sflower.png",insects:"images/insect.png","insects-s":"images/sinsect.png","butterflies and moths":"images/butterfly.png","butterflies and moths-s":"images/sbutterfly.png",birds:"images/bird.png","birds-s":"images/sbird.png",carnivores:"images/carnivore.png","carnivores-s":"images/scarnivore.png",crustaceans:"images/crustacean.png","crustaceans-s":"images/scrustacean.png",rodents:"images/rodent.png","rodents-s":"images/srodent.png",newUserMarker:"images/sblank.png"},e=function(a){this.binomial=a.name,this.keywords=a.name,this.sightings=[]};e.prototype.addKeyword=function(a){this.keywords+=", "+a.toLowerCase()};var n=function(e){this.name=e.name;var n={position:new google.maps.LatLng(e.lat,e.lng),title:e.name+", "+e.date.toDateString(),icon:a.unknown,icons:{selected:a.newUserMarker,unselected:a.unknown},map:null};this.marker=new google.maps.Marker(n),google.maps.event.addListener(this.marker,"click",this.selection.bind(this))};n.prototype.selection=function(){app.map.toggleInfoWindow(this.name,this.marker),app.data.currentSighting===this?this.deselect(!0):this.select()},n.prototype.deselect=function(a){app.data.currentSighting="",a&&app.map.map.panTo(app.map.options.center),this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.unselected),app.viewModel.photos(null)},n.prototype.select=function(){$("#addNew").fadeOut(),app.data.currentSighting&&app.data.currentSighting.deselect(),app.data.currentSighting=this,this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.selected),app.viewModel.photos(app.data.species[this.name].pics)},app.data.addNewSpecies=function(a,n){var t=new e(a),s=t.binomial;app.data.species[s]||(app.data.species[s]=t),n&&(c(s),o(s,n))},app.data.addNewSighting=function(a,e){var t=new n(a),s=t.name;app.data.species[s]&&app.data.species[s].sightings.push(t),e&&e()};var t=function(){for(var a=app.data.basic,e=0,n=a.length;n>e;e++)app.data.addNewSpecies(a[e]),app.data.addNewSighting(a[e])},s=function(a,e){if(-1===a.indexOf(e))return'Property "'+e+'" not found';var n=a.substring(a.indexOf(e)+e.length).replace(/ /g,"");return n.substring(n.indexOf("=")+1,n.indexOf("\n"))},i=function(a){var e={};switch(s(a,"regnum")){case"[[Plant]]ae":switch(e.kingdom="plants",s(a,"unranked_divisio")){case"[[Angiosperms]]":e.division="flowering plants"}break;case"[[Animal]]ia":switch(e.kingdom="animals",s(a,"classis")){case"[[Insect]]a":switch(e["class"]="insects",s(a,"ordo")){case"[[Lepidoptera]]":e.order="butterflies and moths"}break;case"[[bird|Aves]]":case"[[Aves]]":e["class"]="birds";break;case"[[Malacostraca]]":e["class"]="crustaceans";break;case"[[Actinopterygii]]":e["class"]="fishes";break;case"[[Mammal]]ia":switch(e["class"]="mammals",s(a,"ordo")){case"[[Rodent]]ia":e.order="rodents";break;case"[[Carnivora]]":e.order="carnivores"}}break;default:e.kingdom="unknown"}return e},r=function(e){var n=e.query.pages,t=e.query.redirects||null,s=function(a){return a.replace(/<\/?b>/g,"").toLowerCase()};for(var r in n){if("-1"===r)return;var o=n[r].title;if(t)for(var p=0,c=t.length;c>p;p++)o===t[p].to&&(o=t[p].from);var d=n[r].revisions[0]["*"],l=n[r].extract,g=n[r].canonicalurl,m=$("<div>").append($("<h3>").text(o)).append($("<div>").html(l).addClass("extract")).append($("<p>").append($("<a>").attr("href",g).text("[Wikipedia]"))),u=i(d),h=l.match(/<b>(.*?)<\/b>/g).map(s),f=app.data.species[o];f.wm={iwHTML:m[0],url:g,taxon:u,commonNames:h};for(var w in u)f.addKeyword(u[w]);for(var b=0,v=h.length;v>b;b++)f.addKeyword(h[b]);for(var k,y=f.sightings,x=u.order||u["class"]||u.division||u.kingdom,S=0,M=y.length;M>S;S++)k=y[S].marker,k.icons.selected=a[x+"-s"],k.icons.unselected=a[x],k.setIcon(a[x])}},o=function(a,e){var n="https://en.wikipedia.org//w/api.php?action=query&format=json&redirects=&prop=revisions|extracts|info&rvprop=content&rvsection=0&exlimit=max&exintro=&excontinue=true&inprop=url",t=a?[a]:app.data.basic.map(function(a){return a.name}),s=t.join("|");$.ajax({url:n+"&titles="+s,dataType:"jsonp",success:function(a){$("#addNew").prop("disabled",!1).addClass("mdl-button--accent"),$("#readOnly").hide(),r(a),e&&e()},error:function(){$("#addNew").prop("disabled",!0).removeClass("mdl-button--accent"),$("#readOnly").show()}})},p=function(a){for(var e,n=a.photos.photo,t=[],s=0,i=n.length;i>s;s++){var r={};e=n[s],r.src=e.url_q,r.title=e.title||"untitled",r.url="https://www.flickr.com/photos/"+e.owner+"/"+e.id,t.push(r)}return t},c=function(a){var e="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+app.apikeys.FLICKR+"&safe_search=1&content_type=1&extras=url_q&per_page=6&page=1&format=json&nojsoncallback=1";$.ajax({url:e+"&text="+a,dataType:"json",success:function(e){app.data.species[a]&&(app.data.species[a].pics=p(e))}})},d=function(){for(var a=app.data.basic.map(function(a){return a.name}),e=0,n=a.length;n>e;e++)c(a[e])},l=function(){t(),o(),d()};l()}();