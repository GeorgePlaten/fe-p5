!function(){"use strict";app.data={species:{},basic:[{name:"Erithacus rubecula",lat:-33.844263,lng:151.113756,date:new Date("October 13, 2013")},{name:"Erithacus rubecula",lat:-33.843263,lng:151.111756,date:new Date("September 14, 2014")},{name:"Fuchsia magellanica",lat:-33.844548,lng:151.110811,date:new Date("October 1, 2015")},{name:"Polyommatus icarus",lat:-33.845096,lng:151.113337,date:new Date("September 13, 2014")},{name:"Geranium robertianum",lat:-33.844717,lng:151.110467,date:new Date("September 13, 2013")},{name:"Arenaria interpres",lat:-33.844948,lng:151.111011,date:new Date("January 1, 2012")},{name:"Marchantia polymorpha",lat:-33.845343,lng:151.110789,date:new Date("January 2, 2014")}],addNewSpecies:function(e,s){var n=new a(e),t=n.binomial;app.data.species[t]||(app.data.species[t]=n),s&&(p(t),r(t,s))},addNewSighting:function(e,a){var n=new s(e),t=n.name;app.data.species[t]&&app.data.species[t].sightings.push(n),a&&a()}};var e={unknown:"images/blank.png",plants:"images/plant.png","plants-s":"images/splant.png",fishes:"images/fish.png","fishes-s":"images/sfish.png",animals:"images/blank.png","animals-s":"images/sblank.png",mammals:"images/animal.png","mammals-s":"images/sanimal.png","flowering plants":"images/flower.png","flowering plants-s":"images/sflower.png",insects:"images/insect.png","insects-s":"images/sinsect.png","butterflies and moths":"images/butterfly.png","butterflies and moths-s":"images/sbutterfly.png",birds:"images/bird.png","birds-s":"images/sbird.png",carnivores:"images/carnivore.png","carnivores-s":"images/scarnivore.png",crustaceans:"images/crustacean.png","crustaceans-s":"images/scrustacean.png",rodents:"images/rodent.png","rodents-s":"images/srodent.png",newUserMarker:"images/sblank.png"},a=function(e){this.binomial=e.name,this.keywords=e.name,this.sightings=[]};a.prototype.addKeyword=function(e){this.keywords+=", "+e.toLowerCase()};var s=function(a){this.name=a.name;var s={position:new google.maps.LatLng(a.lat,a.lng),title:a.name+", "+a.date.toDateString(),icon:e.unknown,icons:{selected:e.newUserMarker,unselected:e.unknown},map:null};this.marker=new google.maps.Marker(s),google.maps.event.addListener(this.marker,"click",this.selection.bind(this))};s.prototype.selection=function(){app.gMapVM.toggleInfoWindow(this.name,this.marker),app.currentSighting===this?this.deselect(!0):this.select()},s.prototype.deselect=function(e){app.currentSighting="",e&&app.gMapVM.map.panTo(app.gMapVM.mapOptions.center),this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.unselected),app.koViewModel.photos(null)},s.prototype.select=function(){$("#add-new").fadeOut(),app.currentSighting&&app.currentSighting.deselect(),app.currentSighting=this,this.marker.getIcon()&&this.marker.setIcon(this.marker.icons.selected),app.koViewModel.photos(app.data.species[this.name].pics)};var n=function(e,a){if(-1===e.indexOf(a))return'Property "'+a+'" not found';var s=e.substring(e.indexOf(a)+a.length).replace(/ /g,"");return s.substring(s.indexOf("=")+1,s.indexOf("\n"))},t=function(e){var a={};switch(n(e,"regnum")){case"[[Plant]]ae":switch(a.kingdom="plants",n(e,"unranked_divisio")){case"[[Angiosperms]]":a.division="flowering plants"}break;case"[[Animal]]ia":switch(a.kingdom="animals",n(e,"classis")){case"[[Insect]]a":switch(a["class"]="insects",n(e,"ordo")){case"[[Lepidoptera]]":a.order="butterflies and moths"}break;case"[[bird|Aves]]":case"[[Aves]]":a["class"]="birds";break;case"[[Malacostraca]]":a["class"]="crustaceans";break;case"[[Actinopterygii]]":a["class"]="fishes";break;case"[[Mammal]]ia":switch(a["class"]="mammals",n(e,"ordo")){case"[[Rodent]]ia":a.order="rodents";break;case"[[Carnivora]]":a.order="carnivores"}}break;default:a.kingdom="unknown"}return a},i=function(a){var s=a.query.pages,n=a.query.redirects||null,i=function(e){return e.replace(/<\/?b>/g,"").toLowerCase()};for(var r in s){if("-1"===r)return;var o=s[r].title;if(n)for(var p=0,c=n.length;c>p;p++)o===n[p].to&&(o=n[p].from);var l=s[r].revisions[0]["*"],d=s[r].extract,g=s[r].canonicalurl,m=$("<div>").append($("<h3>").text(o)).append($("<div>").html(d).addClass("extract")).append($("<p>").append($("<a>").attr("href",g).text("[Wikipedia]"))),u=t(l),h=d.match(/<b>(.*?)<\/b>/g).map(i),f=app.data.species[o];f.wm={iwHTML:m[0],url:g,taxon:u,commonNames:h};for(var k in u)f.addKeyword(u[k]);for(var w=0,b=h.length;b>w;w++)f.addKeyword(h[w]);for(var v,y=f.sightings,x=u.order||u["class"]||u.division||u.kingdom,M=0,S=y.length;S>M;M++)v=y[M].marker,v.icons.selected=e[x+"-s"],v.icons.unselected=e[x],v.setIcon(e[x])}},r=function(e,a){var s="https://en.wikipedia.org//w/api.php?action=query&format=json&redirects=&prop=revisions|extracts|info&rvprop=content&rvsection=0&exlimit=max&exintro=&excontinue=true&inprop=url",n=e?[e]:app.data.basic.map(function(e){return e.name}),t=n.join("|");$.ajax({url:s+"&titles="+t,dataType:"jsonp",success:function(e){$("#add-new").prop("disabled",!1).addClass("mdl-button--accent"),$(".wikipedia-fail").hide(),$(".wikipedia-ok").show(),$(".ajax-status").removeClass("read-only"),i(e),a&&a()},error:function(){$("#add-new").prop("disabled",!0).removeClass("mdl-button--accent"),$(".wikipedia-ok").hide(),$(".wikipedia-fail").show(),$(".ajax-status").addClass("read-only")}})},o=function(e){for(var a,s=e.photos.photo,n=[],t=0,i=s.length;i>t;t++){var r={};a=s[t],r.src=a.url_q,r.title=a.title||"untitled",r.url="https://www.flickr.com/photos/"+a.owner+"/"+a.id,n.push(r)}return n},p=function(e){var a="https://api.flickr.com/services/rest/?method=flickr.photos.search&api_key="+app.apikeys.FLICKR+"&safe_search=1&content_type=1&extras=url_q&per_page=6&page=1&format=json&nojsoncallback=1";$.ajax({url:a+"&text="+e,dataType:"json",success:function(a){$(".flickr-fail").hide(),$(".flickr-ok").show(),$(".ajax-status").removeClass("flickr-failed"),app.data.species[e]&&(app.data.species[e].pics=o(a))},error:function(){$(".flickr-ok").hide(),$(".flickr-fail").show(),$(".ajax-status").addClass("flickr-failed")}})},c=function(){for(var e=app.data.basic.map(function(e){return e.name}),a=0,s=e.length;s>a;a++)p(e[a])},l=function(){for(var e=app.data.basic,a=0,s=e.length;s>a;a++)app.data.addNewSpecies(e[a]),app.data.addNewSighting(e[a]);r(),c()};l()}();